{
  "db_name": "PostgreSQL",
  "query": "\n            SELECT * FROM (\n                -- Part 1: Aggregated batch transactions\n                SELECT\n                    (array_agg(ct.id ORDER BY ct.seq))[1] as id,\n                    ct.user_id,\n                    'usage' as \"transaction_type!: CreditTransactionType\",\n                    SUM(ct.amount) as amount,\n                    MIN(ct.source_id) as source_id,\n                    CASE\n                        WHEN MIN(ha.model) IS NOT NULL THEN 'Batch - ' || MIN(ha.model)\n                        ELSE 'Batch'\n                    END as description,\n                    MAX(ct.created_at) as created_at,\n                    MAX(ct.seq) as max_seq,\n                    ha.fusillade_batch_id as batch_id\n                FROM credits_transactions ct\n                JOIN http_analytics ha\n                    ON ct.source_id = ha.id::text\n                    AND ct.transaction_type = 'usage'\n                WHERE ($1::uuid IS NULL OR ct.user_id = $1)\n                    AND ha.fusillade_batch_id IS NOT NULL\n                GROUP BY ha.fusillade_batch_id, ct.user_id\n\n                UNION ALL\n\n                -- Part 2: Non-batched transactions\n                SELECT\n                    ct.id,\n                    ct.user_id,\n                    ct.transaction_type as \"transaction_type!: CreditTransactionType\",\n                    ct.amount,\n                    ct.source_id,\n                    ct.description,\n                    ct.created_at,\n                    ct.seq as max_seq,\n                    NULL::uuid as batch_id\n                FROM credits_transactions ct\n                LEFT JOIN http_analytics ha ON ct.source_id = ha.id::text AND ct.transaction_type = 'usage'\n                WHERE ($1::uuid IS NULL OR ct.user_id = $1)\n                    AND (ct.transaction_type != 'usage' OR ha.fusillade_batch_id IS NULL)\n            ) combined\n            ORDER BY max_seq DESC\n            LIMIT $2 OFFSET $3\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "user_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 2,
        "name": "transaction_type!: CreditTransactionType",
        "type_info": "Text"
      },
      {
        "ordinal": 3,
        "name": "amount",
        "type_info": "Numeric"
      },
      {
        "ordinal": 4,
        "name": "source_id",
        "type_info": "Text"
      },
      {
        "ordinal": 5,
        "name": "description",
        "type_info": "Text"
      },
      {
        "ordinal": 6,
        "name": "created_at",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 7,
        "name": "max_seq",
        "type_info": "Int8"
      },
      {
        "ordinal": 8,
        "name": "batch_id",
        "type_info": "Uuid"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid",
        "Int8",
        "Int8"
      ]
    },
    "nullable": [
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null
    ]
  },
  "hash": "7b9e627217551d6303edac55b23d0256d2bbdd5514d2f31956474a800fc01f2b"
}
