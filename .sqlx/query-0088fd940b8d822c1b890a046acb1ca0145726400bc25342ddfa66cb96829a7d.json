{
  "db_name": "PostgreSQL",
  "query": "\n            WITH marked AS (\n                UPDATE credits_transactions\n                SET is_aggregated = true\n                WHERE user_id = $1\n                  AND fusillade_batch_id IS NOT NULL\n                  AND is_aggregated = false\n                RETURNING fusillade_batch_id, amount, seq, created_at, source_id\n            ),\n            with_model AS (\n                SELECT\n                    m.fusillade_batch_id,\n                    m.amount,\n                    m.seq,\n                    m.created_at,\n                    ha.model as model\n                FROM marked m\n                LEFT JOIN http_analytics ha ON m.source_id = ha.id::text\n            ),\n            aggregated AS (\n                SELECT\n                    fusillade_batch_id,\n                    SUM(amount) as total_amount,\n                    COUNT(*) as tx_count,\n                    MAX(seq) as max_seq,\n                    MIN(created_at) as created_at,\n                    MIN(model) as model\n                FROM with_model\n                GROUP BY fusillade_batch_id\n            )\n            INSERT INTO batch_aggregates (fusillade_batch_id, user_id, total_amount, transaction_count, max_seq, model, created_at, updated_at)\n            SELECT fusillade_batch_id, $1, total_amount, tx_count::int, max_seq, model, created_at, NOW()\n            FROM aggregated\n            ON CONFLICT (fusillade_batch_id) DO UPDATE SET\n                total_amount = batch_aggregates.total_amount + EXCLUDED.total_amount,\n                transaction_count = batch_aggregates.transaction_count + EXCLUDED.transaction_count,\n                max_seq = GREATEST(batch_aggregates.max_seq, EXCLUDED.max_seq),\n                model = COALESCE(batch_aggregates.model, EXCLUDED.model),\n                updated_at = NOW()\n            RETURNING fusillade_batch_id\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "fusillade_batch_id",
        "type_info": "Uuid"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid"
      ]
    },
    "nullable": [
      false
    ]
  },
  "hash": "0088fd940b8d822c1b890a046acb1ca0145726400bc25342ddfa66cb96829a7d"
}
