{
  "db_name": "PostgreSQL",
  "query": "\n            SELECT * FROM (\n                -- Part 1: Aggregated batch transactions\n                -- Groups multiple batch requests into single rows (e.g., 100 requests â†’ 1 row)\n                SELECT\n                    (array_agg(ct.id ORDER BY ct.seq))[1] as id,  -- Pick first transaction ID\n                    ct.user_id,                          -- User who owns these transactions\n                    'usage' as \"transaction_type!: CreditTransactionType\",\n                    SUM(ct.amount) as amount,            -- Total cost of all requests in batch\n                    MAX(ct.balance_after) as balance_after,  -- Final balance (after last request)\n                    MIN(ct.source_id) as source_id,      -- Pick first source_id\n                    (array_agg(ct.previous_transaction_id ORDER BY ct.seq))[1] as previous_transaction_id,\n                    CASE\n                        WHEN MIN(ha.model) IS NOT NULL THEN 'Batch - ' || MIN(ha.model)\n                        ELSE 'Batch'\n                    END as description,                  -- \"Batch - gpt-4\" or just \"Batch\"\n                    MAX(ct.created_at) as created_at,    -- Most recent transaction time in batch\n                    MAX(ct.seq) as max_seq,              -- Highest seq in batch (for ordering)\n                    ha.fusillade_batch_id as batch_id    -- The batch ID\n                FROM credits_transactions ct\n                -- Filter by transaction_type before joining to reduce rows\n                JOIN http_analytics ha\n                    ON ct.source_id = ha.id::text\n                    AND ct.transaction_type = 'usage'\n                WHERE ($1::uuid IS NULL OR ct.user_id = $1)  -- Optional user filter (NULL = all users)\n                    AND ha.fusillade_batch_id IS NOT NULL     -- Only requests with batch_id\n                -- NOTE: fusillade_batch_id is user-specific; a batch never spans multiple users.\n                -- We therefore group by both batch_id and user_id to get one row per (user, batch).\n                GROUP BY ha.fusillade_batch_id, ct.user_id\n\n                UNION ALL\n\n                -- Part 2: Non-batched transactions\n                -- Individual transactions: admin grants, purchases, removals, and non-batched usage\n                SELECT\n                    ct.id,\n                    ct.user_id,\n                    ct.transaction_type as \"transaction_type!: CreditTransactionType\",\n                    ct.amount,\n                    ct.balance_after,\n                    ct.source_id,\n                    ct.previous_transaction_id,\n                    ct.description,\n                    ct.created_at,\n                    ct.seq as max_seq,                   -- Individual transaction seq\n                    NULL::uuid as batch_id              -- Not a batch, so NULL\n                FROM credits_transactions ct\n                -- LEFT JOIN so non-usage transactions (grants, purchases) still appear\n                LEFT JOIN http_analytics ha ON ct.source_id = ha.id::text AND ct.transaction_type = 'usage'\n                WHERE ($1::uuid IS NULL OR ct.user_id = $1)  -- Optional user filter (NULL = all users)\n                    AND (ct.transaction_type != 'usage'       -- All non-usage (grants, purchases, removals)\n                         OR ha.fusillade_batch_id IS NULL)    -- OR usage without batch_id\n            ) combined\n            -- Sort by seq (most recent first), then paginate\n            -- Pagination happens AFTER aggregation for correct results\n            ORDER BY max_seq DESC\n            LIMIT $2 OFFSET $3\n            ",
  "describe": {
    "columns": [
      {
        "ordinal": 0,
        "name": "id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 1,
        "name": "user_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 2,
        "name": "transaction_type!: CreditTransactionType",
        "type_info": "Text"
      },
      {
        "ordinal": 3,
        "name": "amount",
        "type_info": "Numeric"
      },
      {
        "ordinal": 4,
        "name": "balance_after",
        "type_info": "Numeric"
      },
      {
        "ordinal": 5,
        "name": "source_id",
        "type_info": "Text"
      },
      {
        "ordinal": 6,
        "name": "previous_transaction_id",
        "type_info": "Uuid"
      },
      {
        "ordinal": 7,
        "name": "description",
        "type_info": "Text"
      },
      {
        "ordinal": 8,
        "name": "created_at",
        "type_info": "Timestamptz"
      },
      {
        "ordinal": 9,
        "name": "max_seq",
        "type_info": "Int8"
      },
      {
        "ordinal": 10,
        "name": "batch_id",
        "type_info": "Uuid"
      }
    ],
    "parameters": {
      "Left": [
        "Uuid",
        "Int8",
        "Int8"
      ]
    },
    "nullable": [
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null,
      null
    ]
  },
  "hash": "1a8d8165334c65055db1a8dee0a27f5cc151e28ccf70f98605e0494dcc7c41ec"
}
